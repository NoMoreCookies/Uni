---
title: "Lista 5"
subtitle: "Analiza przeżycia"
author: "Marta Stankiewicz (282244) \ Kacper Szmigielski (282255)"
header-includes:
   - \usepackage[OT4]{polski}
   - \usepackage[utf8]{inputenc}
   - \usepackage{graphicx}
   - \usepackage{float}
output: 
  pdf_document:
    toc: true
    fig_caption: true
    fig_width: 5 
    fig_height: 4 
    number_sections: true
fontsize: 12pt 
lof: true
lot: true
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.pos = "H", out.extra ='', fig.align = "center")

```
# Lista 1
```{r requirements}
library(survival)
library(survminer)
library(patchwork)
library(RColorBrewer)
library(knitr)
```


## Zadanie 1 

Dane przedstawiają dwie grupy pacjentów, na których badano działanie leków A i B. \
Przedstawione wyniki prezentują czas do remisji choroby.

Dane opisane w zadaniu 3 z lsity 2 : \
Lek A : 0.03345514, 0.08656403, 0.08799947, 0.24385821, 0.27755032, \
0.40787247, 0.58825664, 0.64125620, 0.90679161, 0.94222208

Lek B : 0.03788958, 0.12207257, 0.20319983, 0.24474299, 0.30492413, \
0.34224462, 0.42950144, 0.44484582, 0.63805066, 0.69119721

W każdej z tych grup było jeszcze 10 osób u których nie zaobserwowano remisji choroby.
```{r zad1_dane}

timeA <- c(0.03345514, 0.08656403, 0.08799947, 0.24385821, 0.27755032, 
0.40787247, 0.58825664, 0.64125620, 0.90679161, 0.94222208,rep(1,10))

statusA <- c(rep(1,10),rep(0,10))

timeB <- c(0.03788958, 0.12207257, 0.20319983, 0.24474299, 0.30492413,
0.34224462, 0.42950144, 0.44484582, 0.63805066, 0.69119721,rep(1,10))

statusB <- c(rep(1,10),rep(0,10))

```

### Wykresy Kaplana-Meiera{#wykresy_KM}

```{r zad1_kaplan,fig.cap="Wykres estymatorów Kaplana–Meiera dla leków A i B"}
#------------------------------ Kaplan-Meier------------------------------------

dane.A <- data.frame(time = timeA, status = statusA)

KM.fit.A <- survfit((Surv(time,status)~1), data = dane.A)

KM.df.A <- data.frame(time = KM.fit.A$time , surv = KM.fit.A$surv)

dane.B <- data.frame(time = timeB, status = statusB)

KM.fit.B <- survfit((Surv(time,status)~1), data = dane.B)

KM.df.B <- data.frame(time = KM.fit.B$time , surv = KM.fit.B$surv)

KM.all <- rbind(KM.df.A, KM.df.B)

KM.df.A$group <- "Lek A"
KM.df.B$group <- "Lek B"

KM.all <- rbind(KM.df.A, KM.df.B)

KM.df.A$group <- "Lek A"
KM.df.B$group <- "Lek B"

KM.all <- rbind(KM.df.A, KM.df.B)

ggplot(KM.all, aes(x = time, y = surv, color = group)) +
  geom_step(lwd = 2) +
  labs(x = "Czas", y = "Prawdopodobieństwo braku remisji",
       color = "Grupa") +
          theme_minimal()+
            ggtitle( "Wykres estymatorów Kaplana-Meiera dla leków A i B")+
            scale_color_brewer(palette = "Set2")
```

[Wykres](#wykresy_KM) estymatorów Kaplana–Meiera dla leków A oraz B wskazuje na szybsze osiąganie remisji w grupie leku B – prawdopodobieństwo pozostawania bez remisji spada do 0.5 wcześniej niż w grupie leku A.
[Krzywa](#wykresy_KM) dla leku A jest mniej stroma i przebiega wyżej, co oznacza, że po czasie t = 0,75 około 60% pacjentów wciąż nie osiągnęło remisji, podczas gdy w grupie leku B prawdopodobieństwo braku remisji jest już bliskie 50%

### Wykresy Fleminga-Harringtona{#wykresy_FH}

```{r zad1_harrington,fig.cap="Wykres estymatorów Fleminga-Harringtona dla leków A i B"}
#------------------------------ Fleming-Harrington------------------------------

statusB <- c(rep(1,10),rep(0,10))

dane.A <- data.frame(time = timeA, status = statusA)

KM.fit.A <- survfit((Surv(time,status)~1), data = dane.A,type = "fleming-harrington")

KM.df.A <- data.frame(time = KM.fit.A$time , surv = KM.fit.A$surv)

dane.B <- data.frame(time = timeB, status = statusB)

KM.fit.B <- survfit((Surv(time,status)~1), data = dane.B,type = "fleming-harrington")

KM.df.B <- data.frame(time = KM.fit.B$time , surv = KM.fit.B$surv)

KM.all <- rbind(KM.df.A, KM.df.B)

KM.df.A$group <- "Lek A"
KM.df.B$group <- "Lek B"

KM.all <- rbind(KM.df.A, KM.df.B)

ggplot(KM.all, aes(x = time, y = surv, color = group)) +
  geom_step(lwd = 2) +
  labs(x = "Czas", y = "Prawdopodobieństwo braku remisji",
       color = "Grupa") +
  theme_minimal()+
    ggtitle("Wykres estymatorów Fleminga-Harringtona dla leków A i B")+
  scale_color_brewer(palette = "Set2")

```

Z [wykresu](#wykresy_FH) estymatorów Fleminga–Harringtona dla obu leków można wysnuć wnioski analogiczne jak na podstawie [krzywych](#wykresy_KM) Kaplana–Meiera. Przebieg  [krzywych](#wykresy_FH) dla leków A i B jest bardzo zbliżony, co potwierdza szybsze osiąganie remisji w grupie leku B oraz wskazuje, że wybór estymatora (Kaplana–Meiera vs Fleminga–Harringtona) nie wpływa istotnie na interpretację wyników w tym przykładzie.

Na podstawie obu wykresów można przypuszczać, że leki A i B charakteryzują się zbliżonym profilem skuteczności, przy czym lek B wiąże się z szybszym uzyskaniem remisji. Krzywa przeżycia dla leku B spada szybciej i wcześniej osiąga niższe wartości prawdopodobieństwa braku remisji niż krzywa dla leku A, co sugeruje krótszy czas do remisji w tej grupie.

## Zadanie 2 

### Wykresy estymatorów Kaplana-Meiera dla leków A i B z ogonem{#ogon}
 
```{r zad2,fig.cap="Wykresy estymatorów Kaplana-Meiera dla leków A i B z ogonem"}

KM_z_ogonem_dane <- function(times, status) {
  dane <- data.frame(time = times, status = status)
  
  KM.fit <- survfit(Surv(time, status) ~ 1, data = dane)
  KM.df <- data.frame(time = KM.fit$time, surv = KM.fit$surv)
  
  last_index <- which(KM.df$surv > min(KM.df$surv))
  last_index <- c(last_index, length(last_index) + 1, length(last_index) + 2)
  
  t_plus <- KM.df$time[max(last_index)]
  S_t_plus <- KM.df$surv[max(last_index)]
  
  KM.df <- KM.df[c(last_index), ]
  
  nu <- -log(S_t_plus) / t_plus
  
  t_tail <- seq(t_plus, 3, length.out = 100)
  S_tail <- exp(-nu * t_tail)
  tail_df <- data.frame(time = t_tail, surv = S_tail)
  
  list(KM = KM.df, tail = tail_df,
       t_plus = t_plus, S_t_plus = S_t_plus)
}

dA <- KM_z_ogonem_dane(timeA, statusA)
dB <- KM_z_ogonem_dane(timeB, statusB)

KM_A   <- transform(dA$KM,   grupa = "A")
tail_A <- transform(dA$tail, grupa = "A")

KM_B   <- transform(dB$KM,   grupa = "B")
tail_B <- transform(dB$tail, grupa = "B")

KM_all   <- rbind(KM_A, KM_B)
tail_all <- rbind(tail_A, tail_B)

ggplot() +
  # KM
  geom_step(data = KM_all,
            aes(x = time, y = surv, color = grupa),lwd = 2) +
  # ogony wykładnicze
  geom_line(data = tail_all,
            aes(x = time, y = surv, color = grupa),
            linetype = "dashed",lwd = 2) +
  labs(
    x = "Czas",
    y = "Prawdopodobieństwo braku remisji",
    color = "Grupa"
  ) +
  theme_minimal() +
  ggtitle("Estymator Kaplana-Meiera z ogonem\n dla danych A i B na jednym wykresie")+
  scale_color_brewer(palette = "Set2")


```

[Ogon](#ogon) jest zdefiniowany względem definicji zaproponowanej przez Browna, Hollandera i Kowara. Na skutek czego wzór funkcji  ogona 
w przypadku leku A jak i leku B jest taki sam i wynosi $e^{\frac{{ln\hat{S}(t^{+}})}{t^{+}}*t}$ gdzie w obu przypadkach $t^{+}=\frac{1}{2}$.
[Ogon](#ogon) lepszy sposób odwzorowuje prawdę, że im dłuzej pacjent jest chory tym szansa remisji jest coraz mniejsza

## Zadanie 3

Wybrane parametry to $\alpha=3,\lambda=5$

Dla uogólnionego rozkładu wykładniczego

wartość oczekiwana jest równa $\mathbb{E}(X) = \frac{1}{\lambda}\sum_{k = 1}^{\alpha}{\frac{1}{k}}$
U nas $t_0 = \mathbb{E}(X)$

```{r funkcje_generujace}

gen1 <- function(n, alpha, lambda, t0){
  
  # generujemy dane metodą odwrotnej dystrybuanty
  y <- runif(n)
  x <- - (1/lambda)*log(1- y^(1/alpha))
  
  #liczymy czasy obserwacji oraz czy był cenzurowane
  delta <- ifelse(x <= t0, 1, 0)
  x_obs <- pmin(x, t0)
  
  return(data.frame(time = x_obs, status = delta))
  
}

```

```{r wybór_lambdy_i_alphy}
#wybór lambdy oraz alphy oraz wyliczenia na ich podstawie t0

alpha = 2

lambda = 5

# liczymy t0 ( przybliżona wartość oczekiwana )
t0 = (sum(c(1 / (1:alpha))))/lambda 

```

```{r test}

KM_BHK_S_at <- function(times, status, t_eval) {
  
  # z dostarczonych danych tworzy data.frame
  dane <- data.frame(time = times, status = status)
  
  # funkcja survit do estymatora przeżycia
  KM.fit <- survfit(Surv(time, status) ~ 1, data = dane)

  time <- KM.fit$time
  surv <- KM.fit$surv
  
  # last index, musimy jeszcze dodać te dwa, żeby mieć ten ostatnij schodek, bo survfit zwraca bez niego
  last_index <- which(surv > min(surv))
  last_index <- c(last_index, length(last_index) + 1, length(last_index) + 2)
  
  #moment, w którym doczepiamy ogon
  t_plus <- time[max(last_index)]
  S_t_plus <- surv[max(last_index)]
  
  #wzór dla ogon
  nu <- -log(S_t_plus) / t_plus
  
  #na każdym elemencie listy zwracamy oszacowania
  sapply(t_eval, function(t0) {
    if (t0 <= t_plus) {
      
      surv[max(which(time <= t0))]
    } else {
      
      exp(-nu * t0)
    }
  })
}

```

```{r kolejny_fragment_zadania}
M <- 1000


wyn20  <- matrix(NA, nrow = M, ncol = 2,
                 dimnames = list(NULL, c("t0", "2t0")))
wyn30 <- matrix(NA, nrow = M, ncol = 2,
                 dimnames = list(NULL, c("t0", "2t0")))
wyn50 <- matrix(NA, nrow = M, ncol = 2,
                 dimnames = list(NULL, c("t0", "2t0")))

```

```{r dalsza_część_zadania}

set.seed(123)  

for (i in 1:M) {
  # n = 50
  dat20 <- gen1(20,  alpha, lambda, t0)  
  wyn20[i, ] <- KM_BHK_S_at(dat20$time, dat20$status, c(t0, 2*t0))
  
  # n = 100
  dat30 <- gen1(30, alpha, lambda, t0)
  wyn30[i, ] <- KM_BHK_S_at(dat30$time, dat30$status, c(t0, 2*t0))
  
  # n = 200
  dat50 <- gen1(50, alpha, lambda, t0)
  wyn50[i, ] <- KM_BHK_S_at(dat50$time, dat50$status, c(t0, 2*t0))
}


```

### Wykresy dla n = 20 {#n20}
```{r wykresy_dla_n20}



p1 <- ggplot(data.frame(x = wyn20[, "t0"]), aes(x)) +
  geom_histogram(
    bins = 25,
    color = "black",
    fill  = "#FC8D62",
    lwd   = 1,
    aes(y = after_stat(..density..))
  ) +  
  stat_function(
    fun = dnorm,
    args = list(
      mean = mean(wyn20[, "t0"]),
      sd   = sd(wyn20[, "t0"])
    ),
    linewidth = 1,
    color = "red"
  ) +
  theme_minimal() +
  labs(
    title = "Histogram t0 dla n = 20",
    x     = expression(hat(S)(t[0])),
    y     = "Gęstość"
  )

p2 <- ggplot(data.frame(x = wyn20[, "2t0"]), aes(x)) +
  geom_histogram(
    bins = 25,
    color = "black",
    fill  = "#FC8D62",
    lwd   = 1,
    aes(y = after_stat(..density..))
  ) +
  stat_function(
    fun = dnorm,
    args = list(
      mean = mean(wyn20[, "2t0"]),
      sd   = sd(wyn20[, "2t0"])
    ),
    linewidth = 1,
    color = "red"
  ) +
  theme_minimal() +
  labs(
    title = "Histogram 2t0 dla n = 20",
    x     = expression(hat(S)(t[0])),
    y     = "Gęstość"
  )

p1 | p2

```
[Histogramy](#n20) dla $t_0$ i $2t_0$ ogólnie przypominają rozkład normalny, zwłaszcza w części centralnej.
Widoczne są jednak lokalne odchylenia – pojedyncze słupki wyraźnie odbiegają od krzywej normalnej, co skłania 
do odrzucenia hipotezy o normalności rozkładów.

### Wykresy dla n = 30 {#n30}
```{r wykresy_dla_n30}

p1 <- ggplot(data.frame(x = wyn30[, "t0"]), aes(x)) +
  geom_histogram(
    bins = 25,
    color = "black",
    fill  = "#FC8D62",
    lwd   = 1,
    aes(y = after_stat(..density..))
  ) +  
  stat_function(
    fun = dnorm,
    args = list(
      mean = mean(wyn30[, "t0"]),
      sd   = sd(wyn30[, "t0"])
    ),
    linewidth = 1,
    color = "red"
  ) +
  theme_minimal() +
  labs(
    title = "Histogram t0 dla n = 30",
    x     = expression(hat(S)(t[0])),
    y     = "Gęstość"
  )

p2 <- ggplot(data.frame(x = wyn30[, "2t0"]), aes(x)) +
  geom_histogram(
    bins = 25,
    color = "black",
    fill  = "#FC8D62",
    lwd   = 1,
    aes(y = after_stat(..density..))
  ) +
  stat_function(
    fun = dnorm,
    args = list(
      mean = mean(wyn30[, "2t0"]),
      sd   = sd(wyn30[, "2t0"])
    ),
    linewidth = 1,
    color = "red"
  ) +
  theme_minimal() +
  labs(
    title = "Histogram 2t0 dla n = 30",
    x     = expression(hat(S)(t[0])),
    y     = "Gęstość"
  )

p1 | p2
```

[Tutaj](#n30) analogiczne wnioski jak w przypadku próby o długości 20

### Wykresy dla n = 50 {#n50}
```{r wykresy_dla_n50}

p1 <- ggplot(data.frame(x = wyn50[, "t0"]), aes(x)) +
  geom_histogram(
    bins = 25,
    color = "black",
    fill  = "#FC8D62",
    lwd   = 1,
    aes(y = after_stat(..density..))
  ) +  
  stat_function(
    fun = dnorm,
    args = list(
      mean = mean(wyn50[, "t0"]),
      sd   = sd(wyn50[, "t0"])
    ),
    linewidth = 1,
    color = "red"
  ) +
  theme_minimal() +
  labs(
    title = "Histogram t0 dla n = 50",
    x     = expression(hat(S)(t[0])),
    y     = "Gęstość"
  )

p2 <- ggplot(data.frame(x = wyn50[, "2t0"]), aes(x)) +
  geom_histogram(
    bins = 25,
    color = "black",
    fill  = "#FC8D62",
    lwd   = 1,
    aes(y = after_stat(..density..))
  ) +
  stat_function(
    fun = dnorm,
    args = list(
      mean = mean(wyn50[, "2t0"]),
      sd   = sd(wyn50[, "2t0"])
    ),
    linewidth = 1,
    color = "red"
  ) +
  theme_minimal() +
  labs(
    title = "Histogram 2t0 dla n = 50",
    x     = expression(hat(S)(t[0])),
    y     = "Gęstość"
  )

p1 | p2

```

Dla [n = 200 rozkład](#n50) $t_0$ bardzo już lepiej odwzorowuje kształt wukresy rozkłądu normalnego, ale wciąż występują odchylenia
składaniające do odrzucenia hipotezy o normalności rozkładu.
Podobnie w przypadku $2t_0$

Żeby potwierdzić wnioski z historgamów, wykonamy jeszcze testy shapiro-wilka dla danych.

### Test shapiro-wilka {#wilk}
```{r dane_do_tabelek}



tests <- list(
  "n = 20,  t0"  = shapiro.test(wyn20[ , "t0"]),
  "n = 20, 2t0"  = shapiro.test(wyn20[ , "2t0"]),
  "n = 30, t0"  = shapiro.test(wyn30[, "t0"]),
  "n = 30, 2t0" = shapiro.test(wyn30[, "2t0"]),
  "n = 50, t0"  = shapiro.test(wyn50[, "t0"]),
  "n = 50, 2t0" = shapiro.test(wyn50[, "2t0"])
)

df <- data.frame(
  Próba   = names(tests),
  W       = sapply(tests, function(x) x$statistic),
  p_value = sapply(tests, function(x) x$p.value)
)

kable(df, digits = 6, caption = "Wyniki testu Shapiro–Wilka")


```
[Testy shapiro - wilka](#wilk) potwierdzają podobieństwa rozkładów do normalnych (duże wskaźniki W), ale małe p-value wskazują na odrzuceniu hipotezy o ich normalności.

