---
title: "Lista 2"
output: html_document
date: "2025-10-26"
---

Zadanie 1
```{r zad1}

# gęstość
dexpoexp <- function(x, alpha, lambda, log = FALSE) {
  if (any(alpha <= 0) || any(lambda <= 0)) stop("alpha, lambda must be > 0")
  x <- pmax(x, 0)  # gęstość poza [0,inf) = 0
  logf <- log(alpha) + log(lambda) - lambda * x +
          (alpha - 1) * log1p(-exp(-lambda * x))  # log(1 - e^{-λx}) stabilnie
  if (log) logf else exp(logf)
}

#dystrybuanta
pexpoexp <- function(q, alpha, lambda, lower.tail = TRUE, log.p = FALSE) {
  if (any(alpha <= 0) || any(lambda <= 0)) stop("alpha, lambda must be > 0")
  q <- pmax(q, 0)
  F <- (1 - exp(-lambda * q))^alpha
  if (!lower.tail) F <- 1 - F
  if (log.p) log(F) else F
}
#kwantyl
qexpoexp <- function(p, alpha, lambda, lower.tail = TRUE, log.p = FALSE) {
  if (any(alpha <= 0) || any(lambda <= 0)) stop("alpha, lambda must be > 0")
  if (log.p) p <- exp(p)
  if (!lower.tail) p <- 1 - p
  if (any(p < 0 | p > 1)) stop("p must be in [0,1]")
  -(1 / lambda) * log(1 - p^(1 / alpha))
}

#generator próbek
rexpoexp <- function(n, alpha, lambda) {
  if (length(n) != 1 || n < 0) stop("n must be a non-negative scalar")
  u <- runif(n)
  qexpoexp(u, alpha, lambda)
}

generator_zm_cenzurowanych <- function(n,alpha,lambda,type,t){
  values <- rexpoexp(n,alpha,lambda)
  sorted_values <- sort(values)
  if(type == 1){
    
  censored <-sorted_values>t
  sorted_values <- ifelse(censored, t, sorted_values)
  return (data.frame(sorted_values,censored))
  }
  if(type == 2){
    
    censored <- (1:length(values) > (length(values)-t))
    sorted_values <- ifelse(censored, max(((!censored)*sorted_values)[1:(length(values)-t)]), sorted_values)
    return (data.frame(sorted_values,censored))
  }
  if(type == 3){
    c <-rexp(1,1/t)
    censored <- sorted_values > c
    sorted_values <- ifelse(censored, c, sorted_values)
    return (data.frame(sorted_values,censored))
    
  }
}
print(generator_zm_cenzurowanych(40,8,1,3,3))
```


Zadanie 2


```{r zad2}

wygeneruj_zm_opisowe <- function(values){
 
  censored <- values$censored
  values <- values$sorted_values
  
  results <- c()
  results <- c(results,quantile(values,1/4))
  results <- c(results,quantile(values,1/2))
  results <- c(results,quantile(values,3/4))
  results <- c(results,range(values))
  results <- c(results,quantile(values,3/4)-quantile(values,1/4))
  results <- c(results,sum(censored))
  results <- c(results,length(censored)-sum(censored))
  return (results)
}

print(wygeneruj_zm_opisowe(generator_zm_cenzurowanych(40,8,1,1,3)))
print(wygeneruj_zm_opisowe(generator_zm_cenzurowanych(40,8,1,2,3)))
print(wygeneruj_zm_opisowe(generator_zm_cenzurowanych(40,8,1,3,3)))
```


Zadanie 3


```{r zad3}
## ============================================
## Pakiety
## ============================================
# install.packages(c("survival", "survminer", "survRM2"))
library(survival)
library(survminer)
library(survRM2)

NOTE <- NULL   # fix dla błędu "object 'NOTE' not found"

## ============================================
## Dane
## ============================================
times_A <- c(0.03345514, 0.08656403, 0.08799947, 0.24385821, 0.27755032,
             0.40787247, 0.58825664, 0.64125620, 0.90679161, 0.94222208)

times_B <- c(0.03788958, 0.12207257, 0.20319983, 0.24474299, 0.30492413,
             0.34224462, 0.42950144, 0.44484582, 0.63805066, 0.69119721)

time_A   <- c(times_A, rep(12, 10))
status_A <- c(rep(1, length(times_A)), rep(0, 10))
time_B   <- c(times_B, rep(12, 10))
status_B <- c(rep(1, length(times_B)), rep(0, 10))

df <- rbind(
  data.frame(time = time_A, status = status_A, group = "A"),
  data.frame(time = time_B, status = status_B, group = "B")
)

## ============================================
## Kaplan–Meier
## ============================================
fit <- survfit(Surv(time, status) ~ group, data = df)
cat("Liczebność i liczba remisji:\n")
print(summary(fit)$table[, c("records","events")])

cat("\nMediana czasu remisji (KM, 95% CI):\n")
print(surv_median(fit))

## ============================================
## Kwartyle + IQR
## ============================================
km_quartiles <- function(time, status, probs = c(0.25, 0.5, 0.75)) {
  sf <- survfit(Surv(time, status) ~ 1)
  q  <- quantile(sf, probs = probs)
  extract_quants <- function(obj) {
    if (is.list(obj))    return(extract_quants(obj[[1]]))
    if (is.matrix(obj))  return(if ("quantile" %in% colnames(obj)) obj[, "quantile"] else obj[, 1])
    if (is.numeric(obj)) return(as.numeric(obj))
    stop("Nieoczekiwana struktura zwrócona przez quantile(survfit).")
  }
  qv <- extract_quants(q)
  names(qv) <- c("Q1","Median","Q3")[seq_along(qv)]
  IQR_val <- if (length(qv) >= 3) unname(qv["Q3"] - qv["Q1"]) else NA_real_
  list(quantiles = qv, IQR = IQR_val)
}

resA <- km_quartiles(df$time[df$group=="A"], df$status[df$group=="A"])
resB <- km_quartiles(df$time[df$group=="B"], df$status[df$group=="B"])

cat("\n--- Grupa A ---\n"); print(resA$quantiles); cat("IQR_A:", resA$IQR, "\n")
cat("\n--- Grupa B ---\n"); print(resB$quantiles); cat("IQR_B:", resB$IQR, "\n")

## ============================================
## S(t) w 6 i 12 mies.
## ============================================
s6  <- summary(fit, times = 6)
s12 <- summary(fit, times = 12)

cat("\nS(6 miesięcy):\n")
print(data.frame(group = s6$strata, S = s6$surv, lower = s6$lower, upper = s6$upper), row.names = FALSE)

cat("\nS(12 miesięcy):\n")
print(data.frame(group = s12$strata, S = s12$surv, lower = s12$lower, upper = s12$upper), row.names = FALSE)

## ============================================
## RMST (średni czas bez remisji do 12 mies.)
## ============================================
# rmst2 wymaga numeric 0/1 jako arm:
df$arm <- ifelse(df$group == "B", 1, 0)  # 0 = A, 1 = B
tau_star <- 12

rmst_res <- rmst2(time = df$time,
                  status = df$status,
                  arm = df$arm,
                  tau = tau_star)

cat("\nRMST (0–12 mies.) — Grupa A:\n"); print(rmst_res$RMST.arm0)
cat("\nRMST (0–12 mies.) — Grupa B:\n"); print(rmst_res$RMST.arm1)
cat("\nPorównanie RMST (B vs A):\n"); print(rmst_res$unadjusted.result)

## ============================================
## Wykres Kaplan–Meiera
## ============================================
p <- ggsurvplot(
  fit, data = df, conf.int = TRUE, risk.table = TRUE,
  xlab = "Miesiące", ylab = "S(t) = brak remisji do t",
  legend.title = "Grupa", legend.labs = c("A","B")
)
print(p)

## ============================================
## Porównanie grup
## ============================================
cat("\nTest log-rank (A vs B):\n")
print(survdiff(Surv(time, status) ~ group, data = df))

cat("\nModel Coxa (HR B vs A):\n")
print(summary(coxph(Surv(time, status) ~ group, data = df)))


```
