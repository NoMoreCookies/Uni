---
title: "Lista 11"
subtitle: "Analiza przeżycia"
author: "Marta Stankiewicz (282244) \n Kacper Szmigielski (282255)"
header-includes:
   - \usepackage[OT4]{polski}
   - \usepackage[utf8]{inputenc}
   - \usepackage{graphicx}
   - \usepackage{float}
   - \usepackage{amsthm}
   - \newtheorem{definition}{Definicja}[section]
   - \usepackage{draftwatermark}
   - \SetWatermarkText{{\rmfamily\bfseries KACPER SZMIGIELSKI \\ \rmfamily\bfseries MARTA STANKIEWICZ}}
   - \SetWatermarkScale{2}
   - \SetWatermarkColor[gray]{0.9}
   - \SetWatermarkFontSize{26pt}
output: 
  pdf_document:
    toc: true
    fig_caption: true
    fig_width: 5 
    fig_height: 4 
    number_sections: true
fontsize: 12pt 
lof: true
lot: true
editor_options: 
  markdown: 
    wrap: sentence
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.pos = "H", out.extra ='', fig.align = "center")
```

```{r libraries}
library(survival)
library(eha)
library(knitr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)
library(timereg)
library(nltm)

```

```{r data_import_and_processing}

# data import
data("lung")

# avoiding columns [inst, pat.karno, meal.cal, wt.loss] 
dane <- lung[, 2:7]

# deleting rows with missing values
dane <- dane[complete.cases(dane), ]

mean_wiek <- mean(dane[, 3])
mean_ph_karno <- mean(dane[, 6])

# centering continuous data
dane[, 3] <- dane[, 3] - mean_wiek
dane[, 6] <- dane[, 6] - mean_ph_karno
dane$status <- dane$status -1
```

# Zadanie 1

## Treść

Oszacować parametry modelu proporcjonalnych szans, przyjmując za zmienną zależną zmienną
time, a za charakterystyki zmienne: age, sex, ph.ecog, ph.karno.
Uwaga. Zadanie to można wykonać korzystając np. z funkcji prop.odds biblioteki timereg lub funkcji
nltm biblioteki o tej samej nazwie pakietu R. Należy jednak zwrócić uwagę na inną definicję modelu
proporcjonalnych szans niż była podana na wykładzie wykorzystywaną w tej drugiej funkcji.


## Rozwiązanie

```{r rozw1, echo = TRUE}

model<-prop.odds(Event(time, cause = status) ~ age + factor(sex) + factor(ph.ecog) + ph.karno,
             data = dane,n.sim=500,profile=1)

```

# Zadanie 2

## Treść

Podać interpretację współczynników modelu z zadania 1

## Rozwiązanie


```{r rozw2}

kable(model$gamma)


```

Korzystając z poniższych wzorów możemy podać interpretację:

$$
\theta_0(t) = \frac{1 - S_0(t)}{S_0(t)}
$$

$$
\ln\!\left(\frac{\theta_{z_1}(t)}{\theta_{z_2}(t)}\right) = \beta^{T}(z_1 - z_2)
$$

- Zmienna \texttt{age} ma współczynnik $$\gamma>0,$$ co oznacza, że wraz ze wzrostem wieku rosną \textbf{szanse (odds) wystąpienia zdarzenia do czasu $$t$$} (przy stałych pozostałych zmiennych). Równoważnie: $$\exp(\gamma)>1.$$

- Zmienna \texttt{sex} (kategoryczna) ma współczynnik $$\gamma<0$$ dla poziomu porównywanego do poziomu referencyjnego (bazowego). Oznacza to, że w tej grupie \textbf{szanse (odds) zajścia zdarzenia do czasu $$t$$} są mniejsze niż w grupie bazowej, tj. $$\exp(\gamma)<1.$$

- Zmienna \texttt{ph.ecog} (kategoryczna) ma współczynniki $$\gamma>0$$ dla poszczególnych poziomów w porównaniu do poziomu referencyjnego (np. $$1 \text{ vs } 0,\ 2 \text{ vs } 0,\ 3 \text{ vs } 0$$). Wskazuje to, że osoby z wyższym \texttt{ph.ecog} mają \textbf{większe szanse (odds) wystąpienia zdarzenia do czasu $$t$$} niż osoby z poziomu bazowego, czyli $$\exp(\gamma)>1.$$

- Dla zmiennej ciągłej \texttt{ph.karno} otrzymano $$\gamma<0,$$ co oznacza, że wraz ze wzrostem \texttt{ph.karno} \textbf{maleją szanse (odds) zajścia zdarzenia do czasu $$t$$} (tj. $$\exp(\gamma)<1$$). Jeśli jednak w poprzedniej analizie (Lista 10) współczynnik dla \texttt{ph.karno} był \textbf{nieistotny statystycznie}, to również tutaj wniosek o kierunku efektu należy traktować ostrożnie: przy braku istotności znak współczynnika może zmieniać się między dopasowaniami/modelami i nie powinien być interpretowany jako stabilny efekt.



# Zadanie 3

## Treść

Wyznaczyć oszacowanie bazowej skumulowanej funkcji hazardu i bazowej funkcji przeżycia odpowiadającej rozkładowi czasu życia (przyjmując model opisany w zadaniu 1).
Uwaga. To zadanie można wykonać korzystając np. z funkcji nltm biblioteki o tej samej nazwie.


## Rozwiązanie

```{r rozw3}

s <-  predict(model, Z = c(0,0,0,0,0,0))

df <- data.frame(
  t <- s$time,
  s0 <- c(s$S0),
  H0 <- -log(c(s$S0))
)


p1 <- ggplot() +
  geom_step(data = df, aes(x = t, y = s0,     color = "S0")) +
  labs(color = "Legenda")
p2 <- ggplot() +
  geom_step(data = df, aes(x = t, y = H0, color = "hazard")) +
  labs(color = "Legenda")

p1 / p2

```


# Zadanie 4

## Treść

Wyznaczyć oszacowanie skumulowanej funkcji hazardu odpowiadającej rozkładowi czasu życia
(przyjmując model opisany w zadaniu 1)

```{r model_z_listy_10}

model_l10 <- coxph(Surv(time, status) ~ age + factor(sex) + factor(ph.ecog) + ph.karno,
             data = dane, ties = "efron")


```

## Rozwiązanie

```{r zad4}

model<-prop.odds(Event(time, cause = status) ~ age + factor(sex) + factor(ph.ecog) + ph.karno,
             data = dane,n.sim=500,profile=1)

z1 <- c(70 - mean_wiek, 1, 1, 0, 0, 90 - mean_ph_karno)
z2 <- c(70 - mean_wiek, 1, 0, 1, 0, 90 - mean_ph_karno)

nd <- data.frame(
  age = c(70, 70)-mean_wiek,
  sex = factor(c(2, 2), levels = levels(factor(dane$sex))),     
  ph.ecog = factor(c(1, 2), levels = levels(factor(dane$ph.ecog))),
  ph.karno = c(90, 90)-mean_ph_karno
)



s1 <-  predict(model, Z = z1)
s2 <-  predict(model, Z = z2) 

s_l10 <- survfit(model_l10,nd)

t_10 <- s_l10$time
S_l10 <- as.matrix(s_l10$surv)   

H_l10 <- -log(S_l10)              

df1_l10 <- data.frame(
  t = t_10,
  S0 = S_l10[,1],
  H = H_l10[,1]
)
df2_l10 <- data.frame(
  t = t_10,
  S0 = S_l10[,2],
  H = H_l10[,2]
)

df1 <- data.frame(
  t = s1$time,
  S0  = c(s1$S0),
  H = -log(c(s1$S0))
)

df2 <- data.frame(
  t = s2$time,
  S0  = c(s2$S0),
  H =  -log(c(s2$S0)) 
)


p1_H <- ggplot() +
  geom_step(data = df1,    aes(x = t, y = H, color = "H (model 1)"),linewidth = 1.1) +
  geom_step(data = df1_l10, aes(x = t, y = H, color = "H (model l10)"),linewidth = 1.1)+
  ggtitle("Funkcja H dla pacjenta 1")

p1_logH <- ggplot() +
  geom_step(data = df1,    aes(x = t, y = log(H), color = "log(H) (model 1)"),linewidth = 1.1) +
  geom_step(data = df1_l10, aes(x = t, y = log(H), color = "log(H) (model l10)"),linewidth = 1.1)+
  ggtitle("Funkcja log(H) dla pacjenta 1")


p2_H <- ggplot() +
  geom_step(data = df2,    aes(x = t, y = H, color = "H (model 1)"),linewidth = 1.1) +
  geom_step(data = df2_l10, aes(x = t, y = H, color = "H (model l10)"),linewidth = 1.1)+
  ggtitle("Funkcja H dla pacjenta 2")

p2_logH <-ggplot() +
  geom_step(data = df2,    aes(x = t, y = log(H), color = "log(H) (model 1)"),linewidth = 1.1) +
  geom_step(data = df2_l10, aes(x = t, y = log(H), color = "log(H) (model l10)"),linewidth = 1.1)+
  ggtitle("Funkcja log(H) dla pacjenta 2")

(p1_H | p2_H) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")


```
Widzimy, że w przypadku pacjenta 1 skumulowany hazard rośnie wyraźnie szybciej, gdy użyjemy modelu proporcjonalnych szans, niż wtedy, gdy korzystamy z modelu proporcjonalnych hazardów Coxa. Oznacza to, że model proporcjonalnych szans przewiduje dla tego pacjenta gorsze przeżycie (większe skumulowane ryzyko w czasie) niż model Coxa.

W przypadku pacjenta 2 krzywe są bardzo podobne mniej więcej do 625 dnia, a później zaczynają się rozjeżdżać. W dalszej części obserwacji różnice między modelami rosną, jednak interpretację samej końcówki należy traktować ostrożnie, ponieważ w ogonie czasu często zostaje niewiele obserwacji i pojedyncze zdarzenia potrafią powodować wyraźne „skoki” krzywej.

```{r logarytmy_funkcji}

(p1_logH | p2_logH)+
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```
Analogiczne wnioski możemy wysnuć także na podstawie wykresów logarytmów tych funkcji, ponieważ logarytm jest funkcją ściśle rosnącą i dla dodatnich wartości zachowuje relacje.
# Zadanie 5

## Treść
Wyznaczyć oszacowanie funkcji przeżycia (w dniach) odpowiadającej rozkładowi czasu życia

## Rozwiążanie

```{r wykresy_przeżycia}

ggplot()+
  geom_step(data = df1, aes(x = t, y = S0, color = "S01"),linewidth = 1.1)+
  geom_step(data = df2, aes(x = t, y = S0, color = "S02"),linewidth = 1.1)


```
Z wykresów widać, że funkcja przeżycia dla pacjenta 2 maleje znacznie szybciej, co jest zgodne z charakterystyką danych.

Prawdopodobieństwa tego ,że czas życia będzie większy od 300 , to $$S_{0}2(300)$$ i $$S_{0}1(300)$$

Dla pacjenta 1 to prawdopodobieństwo wynosi:

```{r dzielny_pacjent_1}
i <- findInterval(300, s1$time)   
S_300 <- if (i == 0) 1 else s1$S0[i]
S_300


```
Jest to spora szansa.

A na liście 10 otrzymaliśmy:

```{r dzielny_pacjent_1_l10}

i <- findInterval(300, t_10)   
S_300 <- if (i == 0) 1 else S_l10[,1][i]
S_300

```
Prawdopodobieństwo dla modelu proporcjonalnych hazardów coxa jest większe.

Dla pacjenta 2 to prawdopodobieństwo wynosi:

```{r dzielny_pacjent_2}

i <- findInterval(300, s2$time)   
S_300 <- if (i == 0) 1 else s2$S0[i]
S_300

```
W stosunku do pacjenta pierwszego widać spadek aż o 20 punktów procentowych na liście 11.



```{r dzielny_pacjent_2_l10}

i <- findInterval(300, t_10)   
S_300 <- if (i == 0) 1 else S_l10[,2][i]
S_300

```
Prawdopodobieństwo dla modelu proporcjonalnych hazardów coxa jest większe.

# Zadanie 6

## Treść

 Narysować wykres oszacowanej w zadaniu 5 punkt (a) funkcji przeżycia i porównać go z wykresem
z zadania 6 z listy 10.

## Rozwiązanie


```{r zad6}

ggplot()+
  geom_step(data = df1, aes(x = t, y = S0, color = "S01"),linewidth = 1.1)+
  geom_step(data = df1_l10, aes(x = t, y = S0, color = "S01_l10"),linewidth = 1.1)

```
Widać, że funkcja przeżycia jest większa dla modelu proporcjonalnych hazardów coxa, niż w obecnym modelu
proporcjonalnych szans.
