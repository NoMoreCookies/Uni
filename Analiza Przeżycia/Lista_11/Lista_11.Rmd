---
title: "Sprawozdanie 2"
subtitle: "Analiza przeżycia"
author: "Marta Stankiewicz (282244) \n Kacper Szmigielski (282255)"
header-includes:
   - \usepackage[OT4]{polski}
   - \usepackage[utf8]{inputenc}
   - \usepackage{graphicx}
   - \usepackage{float}
   - \usepackage{amsthm}
   - \newtheorem{definition}{Definicja}[section]
output: 
  pdf_document:
    toc: true
    fig_caption: true
    fig_width: 5 
    fig_height: 4 
    number_sections: true
fontsize: 12pt 
lof: true
lot: true
editor_options: 
  markdown: 
    wrap: sentence
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.pos = "H", out.extra ='', fig.align = "center")
```

```{r libraries}
library(survival)
library(eha)
library(knitr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)
library(timereg)
library(nltm)

```

```{r data_import_and_processing}

# data import
data("lung")

# avoiding columns [inst, pat.karno, meal.cal, wt.loss] 
dane <- lung[, 2:7]

# deleting rows with missing values
dane <- dane[complete.cases(dane), ]

mean_wiek <- mean(dane[, 3])
mean_ph_karno <- mean(dane[, 6])

# centering continuous data
dane[, 3] <- dane[, 3] - mean_wiek
dane[, 6] <- dane[, 6] - mean_ph_karno
dane$status <- dane$status -1
```

# Zadanie 1

**Dopasowanie modelu(oszacowanie parametrów)**

```{r rozw1, echo = TRUE}

model<-prop.odds(Event(time, cause = status) ~ age +
                 factor(sex) +
                 factor(ph.ecog) + 
                 ph.karno,
                 data = dane,n.sim=500,profile=1)

```

# Zadanie 2



Korzystając z poniższych wzorów możemy podać interpretację:

$$
\theta_0(t) = \frac{1 - S_0(t)}{S_0(t)}
$$

$$
\ln\!\left(\frac{\theta_{z_1}(t)}{\theta_{z_2}(t)}\right) = \beta^{T}(z_1 - z_2)
$$
$$
\ln\left({\theta_{z_1}(t)}\right)=\beta^{T}(z_1).
$$


**Tabela współczynników**

```{r rozw2}

kable(model$gamma, caption = "Tabela otrzymanych wsp. beta", digits = 4)

b_age = model$gamma["age",]
b_sex = model$gamma["factor(sex)2",]
b_karno = model$gamma["ph.karno",]


```

- Zmienna \texttt{age} ma współczynnik $\beta$ = `r b_age`>0, co oznacza, że wraz ze wzrostem wieku rosną \textbf{szanse (odds) wystąpienia zdarzenia do czasu $$t$$} (przy stałych pozostałych zmiennych). Równoważnie: $$\exp(\beta)>1.$$

- Zmienna \texttt{sex} (kategoryczna) ma współczynnik $\beta$ = `r b_sex`>0 dla poziomu porównywanego do poziomu referencyjnego (bazowego). Oznacza to, że w tej grupie \textbf{szanse (odds) zajścia zdarzenia do czasu $$t$$} są mniejsze niż w grupie bazowej, tj. $$\exp(\beta)<1.$$

- Zmienna \texttt{ph.ecog} (kategoryczna) ma współczynniki $$\beta>0$$ dla poszczególnych poziomów w porównaniu do poziomu referencyjnego (np. $$1 \text{ vs } 0,\ 2 \text{ vs } 0,\ 3 \text{ vs } 0$$). Wskazuje to, że osoby z wyższym \texttt{ph.ecog} mają \textbf{większe szanse (odds) wystąpienia zdarzenia do czasu $$t$$} niż osoby z poziomu bazowego, czyli $$\exp(\beta)>1.$$

- Dla zmiennej ciągłej \texttt{ph.karno} otrzymano $\beta$ = `r b_karno`<0 co oznacza, że wraz ze wzrostem \texttt{ph.karno} \textbf{maleją szanse (odds) zajścia zdarzenia do czasu $$t$$} (tj. $$\exp(\beta)<1$$). Jeśli jednak w poprzedniej analizie (Lista 10) współczynnik dla \texttt{ph.karno} był \textbf{nieistotny statystycznie}, to również tutaj wniosek o kierunku efektu należy traktować ostrożnie: przy braku istotności znak współczynnika może zmieniać się między dopasowaniami/modelami i nie powinien być interpretowany jako stabilny efekt.

# Zadanie 3

```{r rozw, fig.cap="Podstawowa funkcja przeżycia i skumulowanego hazardu"}

s <-  predict(model, Z = c(0,0,0,0,0,0))

df <- data.frame(
  t <- s$time,
  s0 <- c(s$S0),
  H0 <- -log(c(s$S0))
)


p1 <- ggplot() +
  geom_step(data = df, aes(x = t, y = s0,     color = "S0")) +
  labs(color = "Legenda")+
  ggtitle("Oszacowanie podstawowej funkcji przeżycia")

p2 <- ggplot() +
  geom_step(data = df, aes(x = t, y = H0, color = "hazard")) +
  labs(color = "Legenda")+
  ggtitle("Oszacowanie podstawowego skumulowanego Hazardu")

p1 / p2

```


# Zadanie 4

```{r model_z_listy_10}

model_l10 <- coxph(Surv(time, status) ~ age + factor(sex) + factor(ph.ecog) + ph.karno,
             data = dane, ties = "efron")


```


```{r zad4}

model<-prop.odds(Event(time, cause = status) ~ age + factor(sex) + factor(ph.ecog) + ph.karno,
             data = dane,n.sim=500,profile=1)

z1 <- c(70 - mean_wiek, 1, 1, 0, 0, 90 - mean_ph_karno)
z2 <- c(70 - mean_wiek, 1, 0, 1, 0, 90 - mean_ph_karno)

nd <- data.frame(
  age = c(70, 70)-mean_wiek,
  sex = factor(c(2, 2), levels = levels(factor(dane$sex))),     
  ph.ecog = factor(c(1, 2), levels = levels(factor(dane$ph.ecog))),
  ph.karno = c(90, 90)-mean_ph_karno
)


s1 <-  predict(model, Z = z1)
s2 <-  predict(model, Z = z2) 

s_l10 <- survfit(model_l10,nd)

t_10 <- s_l10$time
S_l10 <- as.matrix(s_l10$surv)   

H_l10 <- -log(S_l10)              

df1_l10 <- data.frame(
  t = t_10,
  S0 = S_l10[,1],
  H = H_l10[,1]
)
df2_l10 <- data.frame(
  t = t_10,
  S0 = S_l10[,2],
  H = H_l10[,2]
)

df1 <- data.frame(
  t = s1$time,
  S0  = c(s1$S0),
  H = -log(c(s1$S0))
)

df2 <- data.frame(
  t = s2$time,
  S0  = c(s2$S0),
  H =  -log(c(s2$S0)) 
)
```


```{r  wykres_hazardu_p1}
p1_H <- ggplot() +
  geom_step(data = df1,    aes(x = t, y = H, color = "H (model 1)"),linewidth = 1.1) +
  geom_step(data = df1_l10, aes(x = t, y = H, color = "H (model l10)"),linewidth = 1.1)+
  ggtitle("Funkcja H dla pacjenta 1")
```

```{r  wykres_loghazardu_p1}
p1_logH <- ggplot() +
  geom_step(data = df1,    aes(x = t, y = log(H), color = "log(H) (model 1)"),linewidth = 1.1) +
  geom_step(data = df1_l10, aes(x = t, y = log(H), color = "log(H) (model lista_10)"),linewidth = 1.1)+
  ggtitle("Funkcja log(H) \n dla pacjenta 1")
```

```{r  wykres_hazardu_p2}
p2_H <- ggplot() +
  geom_step(data = df2,    aes(x = t, y = H, color = "H (model 1)"),linewidth = 1.1) +
  geom_step(data = df2_l10, aes(x = t, y = H, color = "H (model l10)"),linewidth = 1.1)+
  ggtitle("Funkcja H dla pacjenta 2")
```

```{r  wykres_loghazardu, fig.cap="wykresy-skumulowanego-hazardu"}
p2_logH <-ggplot() +
  geom_step(data = df2,    aes(x = t, y = log(H), color = "log(H) (model 1)"),linewidth = 1.1) +
  geom_step(data = df2_l10, aes(x = t, y = log(H), color = "log(H) (model lista_10)"),linewidth = 1.1)+
  ggtitle("Funkcja log(H) \n dla pacjenta 2")

(p1_H | p2_H) +
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")


```

W przypadku pacjenta 1  widać, że skumulowany hazard \ref{fig:wykres_loghazardu} estymowany w modelu proporcjonalnych szans rośnie wyraźnie szybciej niż w modelu proporcjonalnych hazardów Coxa. W konsekwencji model proporcjonalnych szans implikuje dla tego pacjenta mniej korzystną prognozę przeżycia, tj. większe narastające ryzyko zdarzenia w czasie, w porównaniu z modelem Coxa.

Dla pacjenta 2 krzywe \ref{fig:wykres_loghazardu} skumulowanego hazardu są do około 625 dnia bardzo zbliżone, natomiast w dalszej części obserwacji zaczynają się rozchodzić. Różnice między predykcjami modeli narastają wraz z upływem czasu, jednak interpretację końcowego fragmentu należy traktować z ostrożnością — w ogonie rozkładu zwykle pozostaje niewiele obserwacji, a pojedyncze zdarzenia mogą powodować relatywnie duże, skokowe zmiany estymowanych krzywych.

```{r logarytmy_funkcji,fig.cap="wykresy-log(skumulowany hazard)"}

(p1_logH | p2_logH)+
  plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```
Analogiczne wnioski możemy wysnuć także na podstawie wykresu \ref{fig:logarytmy_funkcji} logarytmów  tych funkcji, ponieważ logarytm jest funkcją ściśle rosnącą i dla dodatnich wartości zachowuje relacje.

# Zadanie 5


```{r wykresy_przeżycia, fig.cap="wykresy funkcji przeżycia dla pacjentów"}

ggplot()+
  geom_step(data = df1, aes(x = t, y = S0, color = "S01"),linewidth = 1.1)+
  geom_step(data = df2, aes(x = t, y = S0, color = "S02"),linewidth = 1.1)


```
Z wykresu \ref{fig:wykresy_przeżycia} widać, że funkcja przeżycia dla pacjenta 2 maleje znacznie szybciej, co jest zgodne z charakterystyką danych.

Prawdopodobieństwa tego ,że czas życia będzie większy od 300 , to $$S_{0}2(300)$$ i $$S_{0}1(300)$$

Dla pacjenta 1 to prawdopodobieństwo wynosi:

```{r dzielny_pacjent_1}

i <- findInterval(300, s1$time)   
S_300 <- if (i == 0) 1 else s1$S0[i]
S_300


```
Jest to spora szansa.

A na liście 10 otrzymaliśmy:

```{r dzielny_pacjent_1_l10}

i <- findInterval(300, t_10)   
S_300 <- if (i == 0) 1 else S_l10[,1][i]
S_300

```
Prawdopodobieństwo dla modelu proporcjonalnych hazardów coxa jest większe.

Dla pacjenta 2 to prawdopodobieństwo wynosi:

```{r dzielny_pacjent_2}

i <- findInterval(300, s2$time)   
S_300 <- if (i == 0) 1 else s2$S0[i]
S_300

```
W stosunku do pacjenta pierwszego widać spadek aż o 20 punktów procentowych na liście 11.



```{r dzielny_pacjent_2_l10}

i <- findInterval(300, t_10)   
S_300 <- if (i == 0) 1 else S_l10[,2][i]
S_300

```
Prawdopodobieństwo dla modelu proporcjonalnych hazardów coxa jest większe.

# Zadanie 6



```{r zad6, fig.cap="wykresy funkcji przeżycia"}

ggplot()+
  geom_step(data = df1, aes(x = t, y = S0, color = "S01"),linewidth = 1.1)+
  geom_step(data = df1_l10, aes(x = t, y = S0, color = "S01_l10"),linewidth = 1.1)

```

Z wykresu \ref{fig:zad6} wynika, że estymowana funkcja przeżycia w modelu proporcjonalnych hazardów Coxa przyjmuje wyższe wartości niż w rozważanym modelu proporcjonalnych szans. Oznacza to, że model Coxa przewiduje korzystniejsze rokowanie (większe prawdopodobieństwo przeżycia od czasu 
t) w porównaniu z modelem proporcjonalnych szans.
