---
title: "Lista 11"
subtitle: "Analiza przeżycia"
author: "Marta Stankiewicz (282244) \n Kacper Szmigielski (282255)"
header-includes:
   - \usepackage[OT4]{polski}
   - \usepackage[utf8]{inputenc}
   - \usepackage{graphicx}
   - \usepackage{float}
   - \usepackage{amsthm}
   - \newtheorem{definition}{Definicja}[section]
   - \usepackage{draftwatermark}
   - \SetWatermarkText{{\rmfamily\bfseries KACPER SZMIGIELSKI \\ \rmfamily\bfseries MARTA STANKIEWICZ}}
   - \SetWatermarkScale{2}
   - \SetWatermarkColor[gray]{0.9}
   - \SetWatermarkFontSize{26pt}
output: 
  pdf_document:
    toc: true
    fig_caption: true
    fig_width: 5 
    fig_height: 4 
    number_sections: true
fontsize: 12pt 
lof: true
lot: true
editor_options: 
  markdown: 
    wrap: sentence
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = FALSE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(fig.pos = "H", out.extra ='', fig.align = "center")
```

```{r libraries}

library(survival)
library(eha)
library(knitr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(patchwork)
library(timereg)
library(nltm)

```

# Zadanie 1

```{r dane}

data("lung")

dane <- lung[, 2:7]

dane <- dane[complete.cases(dane), ]

mean_wiek <- mean(dane[, 3])
mean_ph_karno <- mean(dane[, 6])

dane[, 3] <- dane[, 3] - mean_wiek
dane[, 6] <- dane[, 6] - mean_ph_karno

dane$status <-  dane$status-1


```
## Treść

Przyjmując model przyspieszonego czasu awarii, w którym bazowa funkcja przeżycia odpowiada
rozkładowi Weibulla, przyjmując za zmienną zależną zmienną time, a za charakterystyki zmienne:
age, sex, ph.ecog, ph.karno, wykonać poniższe zadania.

## Rozwiązanie

### a)

#### Treść

 Korzystając z testu Walda oraz testu IW, na poziomie istotności 0.05, zweryfikować hipotezę,
że zmienna age nie jest istotna w przyjętym modelu

#### Rozwiązanie


##### Wald
P value dla testu Walda wynosi:

```{r zad1a_Wald}

# parameter estimation (based on example in lecture)
model <- survreg(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane,
                 dist = "weibull")


tab <- summary(model)$table

print(tab["age", ]["p"])

```
Widać, że p > 0.05

Nie odrzucamy $$H_0$$, więc uznajemy zmienną age za nieistotną

##### IW
P value dla testu największej wiarygodności wynosi:
```{r zad1a_Anova}

#noage
model_noage <- update(model, . ~ . - age)
anova(model_noage, model)$"Pr(>Chi)"[2]

```
Widać, że p > 0.05
Nie odrzucamy $$H_0$$, więc uznajym zmienną age za nieistotną

### b)

##### Wald
P value dla testu Walda wynosi:

```{r zad1b_wald}

tab["as.factor(sex)2",]["p"]

```
Odrzucamy $$H_0$$, więc uznajemy zmienną sex za istotną


##### IW
P value dla testu największej wiarygodności wynosi:

```{zad1b_IW}
#nosex
model_nosex <- update(model, . ~ . - as.factor(sex))
anova(model_nosex, model)$"Pr(>Chi)"[2]


```

Widać, że p < 0.05
Odrzucamy $$H_0$$, więc uznajemy zmienną sex za istotną


### c)

#### Treść

(c) Korzystając z testu ilorazu wiarogodności, na poziomie istotności 0.05, zweryfikować hipotezę,
że rozkład czasu życia jest taki sam dla pacjenta o sprawności ECOG wg. lekarza na poziomie
0, 1, 2, 3 (zmienna ph.ecog teoretycznie może przyjmować wartości 0, 1, 2, 3, 4, 5, ale w zbiorze
danych mamy tylko wartości od 0 do 3)


#### Rozwiązanie

##### IW

P value dla testu największej wiarygodności wynosi:

```{r rozwc}


#noage
model_noecog <- update(model, . ~ . - as.factor(ph.ecog))
anova(model_noecog, model)$"Pr(>Chi)"[2]

```
W teście ilorazu wiarygodności otrzymano p = 0.00214 < 0.05, więc odrzucamy hipotezę $$H_0$$, że rozkład czasu życia jest taki sam dla pacjentów z ECOG 0,1,2,3. Oznacza to, że zmienna ph.ecog jest istotna w przyjętym modelu

# Zadanie 2

## Treść 

Przyjmując model proporcjonalnych hazardów Coxa ze zmienną zależną time, i z charakterystykami:
age, sex, ph.ecog, ph.karno, wykonać poniższe zadania.

## Rozwiązanie

```{r model_podst_coxph}
# parameter estimation (based on example in lecture)
model_podst <- coxph(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane,)

```

### a)

#### Treść

 Korzystając z testu Walda oraz z testu IW, na poziomie istotności 0.05, zweryfikować hipotezę,
że zmienna age nie jest istotna w przyjętym modelu

#### Rozwiąza

##### Wald 
P value dla testu największej wiarygodności wynosi:

```{r ageWald}

tab <- summary(model_podst)$coefficients

tab["age",][5]

```
Widać, że p > 0.05
Nie odrzucamy $$H_0$$, więc uznajemy zmienną age za nieistotną

##### IW

P value dla testu największej wiarygodności wynosi:

```{r ageIW}
m0 <- update(model_podst, . ~ . - age)

print(anova(m0, model_podst, test = "LRT")["Pr(>|Chi|)"])   

```
Widać, że p > 0.05
Nie odrzucamy $$H_0$$, więc uznajemy zmienną age za nieistotną

### b)

#### Treść

Korzystając z testu Walda oraz testu IW, na poziomie istotności 0.05, zweryfikować hipotezę,
że zmienna sex nie jest istotna w przyjętym modelu

#### Rozwiązanie

##### Wald 
P value dla testu największej wiarygodności wynosi:

```{r sexWald}
tab["as.factor(sex)2",]["Pr(>|z|)"]
```
Widać, że p < 0.05
Odrzucamy $$H_0$$, więc uznajemy zmienną sex za istotną

##### IW

P value dla testu największej wiarygodności wynosi:

```{r sexIW}
m0 <- update(model_podst, . ~ . - as.factor(sex))

print(anova(m0, model_podst, test = "LRT")["Pr(>|Chi|)"])  

```
Widać, że p < 0.05
Odrzucamy $$H_0$$, więc uznajemy zmienną sex za istotną

### c)

#### Treść

Korzystając z testu ilorazu wiarogodności, na poziomie istotności 0.05, zweryfikować hipotezę,
że rozkład czasu życia jest taki sam dla pacjenta o sprawności ECOG wg. lekarza na poziomie
0, 1, 2, 3 (zmienna ph.ecog teoretycznie może przyjmować wartości 0, 1, 2, 3, 4, 5, ale w zbiorze
danych mamy tylko wartości od 0 do 3)

#### Rozwiązanie

P value dla testu największej wiarygodności wynosi:

```{r ecogIW}

m0 <- update(model_podst, . ~ . - as.factor(ph.ecog))

print(anova(m0, model_podst, test = "LRT")["Pr(>|Chi|)"]) 

```

W teście ilorazu wiarygodności otrzymano p < 0.05, więc odrzucamy hipotezę $$H_0$$, że rozkład czasu życia jest taki sam dla pacjentów z ECOG 0,1,2,3. Oznacza to, że zmienna ph.ecog jest istotna w przyjętym modelu

# Zadanie 3

## Treść 

Przyjmując model przyspieszonego czasu awarii, w którym bazowa funkcja przeżycia odpowiada
rozkładowi Weibulla, przyjmując za zmienną zależną zmienną time, a za charakterystyki zmienne:
age, sex, ph.ecog, ph.karno, wykonać poniższe zadania.

## Rozwiązanie

### a)

#### Treść

Korzystając z metody eliminacji, w oparciu o test ilorazu wiarogodności, dokonać wyboru
zmiennych do modelu przyspieszonego czasu awarii.

#### Rozwiązanie

Korzystając z metody eliminacji wybierzemy modelprzyspiezonego czasu awarii


KROK 1
```{r mEliminacji_krkk1}

m <- survreg(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane,
                 dist = "weibull")

p_age     <- anova(update(m, . ~ . - age), m)["Pr(>Chi)"][2,]
p_sex     <- anova(update(m, . ~ . - as.factor(sex)), m)["Pr(>Chi)"][2,]
p_phecog  <- anova(update(m, . ~ . - as.factor(ph.ecog)), m)["Pr(>Chi)"][2,]
p_phkarno <- anova(update(m, . ~ . - ph.karno), m)["Pr(>Chi)"][2,]


df <- data.frame(
  zmienna = c("age","sex","ph.ecog","ph.karno"),
  p_value = c(p_age, p_sex, p_phecog, p_phkarno)
)

knitr::kable(df, digits = 4)

```
Usuwamy age bo ma najwięszke p > 0.05

KROK 2

```{r krkkk2}



m <- survreg(Surv(time, status)~as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane,
                 dist = "weibull")

p_sex     <- anova(update(m, . ~ . - as.factor(sex)), m)["Pr(>Chi)"][2,]
p_phecog  <- anova(update(m, . ~ . - as.factor(ph.ecog)), m)["Pr(>Chi)"][2,]
p_phkarno <- anova(update(m, . ~ . - ph.karno), m)["Pr(>Chi)"][2,]


df <- data.frame(
  zmienna = c("sex","ph.ecog","ph.karno"),
  p_value = c( p_sex, p_phecog, p_phkarno)
)

knitr::kable(df, digits = 4)
```

Usuwamy zmienną ph.karno bo ma największe p > 0.05

KROK 3

```{r krkrk3}


m <- survreg(Surv(time, status)~as.factor(sex) + as.factor(ph.ecog),
                 data = dane,
                 dist = "weibull")

p_sex     <- anova(update(m, . ~ . - as.factor(sex)), m)["Pr(>Chi)"][2,]
p_phecog  <- anova(update(m, . ~ . - as.factor(ph.ecog)), m)["Pr(>Chi)"][2,]


df <- data.frame(
  zmienna = c("sex","ph.ecog"),
  p_value = c( p_sex, p_phecog)
)

knitr::kable(df, digits = 4)
```
Dla teraz wszystkie p < 0.05 więc mamy już gotowy model AIC.
W modelu końcowym zakłada się , że jedynymi znaczącymi zmiennymi są sex i ph.ecog

### b)

#### Treść

Korzystając z kryterium informacyjnego Akaike’a (AIC), dokonać wyboru najlepszego modelu
przyspieszonego czasu awarii, korzystając z funkcji step.

#### Rozwiązanie

```{r z_funkcją_step}
m <- survreg(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane,
                 dist = "weibull")
m_aic <- step(m, direction = "backward", trace = 1)

```

KROK 1
Z funkcji step widzimy, że wskażnik AIC
był najmniejszy dla zmiennej ph.karno, więc została ona usunięta.

KROK 2
Z funkcji step widzimy, że wskażnik AIC  
był najmniejszy dla zmiennej age, więc została ona usunięta.

KROK 3
Z funkcji step widzimy, że wskażnik AIC  
zwiększa sie w każdym możliwym kroku, więc nie ma sensu usuwać już żadnych zmiennych.



### c)

#### Treść

Korzystając z bayesowskiego kryterium informacyjnego (BIC), dokonać wyboru najlepszego
modelu przyspieszonego czasu awarii, korzystając z funkcji step.

#### Rozwiązanie

```{r BICsteps}

m <- survreg(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane,
                 dist = "weibull")

n <- sum(dane$status)

m_bic <- step(m, direction = "backward", k = log(n), trace = 1)


```

KROK 1
Z funkcji step widzimy, że wskażnik BIC
był najmniejszy dla zmiennej ph.karno, więc została ona usunięta.

KROK 2
Z funkcji step widzimy, że wskażnik BIC 
był najmniejszy dla zmiennej age, więc została ona usunięta.

KROK 3
Z funkcji step widzimy, że wskażnik BIC 
zwiększa sie w każdym możliwym kroku, więc nie ma sensu usuwać już żadnych zmiennych.

Nasz końcowy model zawiera zmienne sex oraz ph.ecoh ponieważ możemy uznać je za istotnie znaczące.

# Zadanie 4

## Treść

 Przyjmując model proporcjonalnych hazardów Coxa ze zmienną zależną time, a za charakterystyki
zmienne: age, sex, ph.ecog, ph.karno, wykonać poniższe zadania.

## Rozwiązanie

### a)

#### Treść

Korzystając z metody eliminacji, w oparciu o test ilorazu wiarogodności, dokonać wyboru
zmiennych do modelu przyspieszonego czasu awarii.

#### Rozwiązanie

```{r mEliminacjik_krk1_coxph}

m <- coxph(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane)
df <- data.frame(
  "age" = anova(update(m, . ~ . - age), m)[["Pr(>|Chi|)"]][2],
  "sex" = anova(update(m, . ~ . - as.factor(sex)),      m)[["Pr(>|Chi|)"]][2],
  "ph.ecog" = anova(update(m, . ~ . - as.factor(ph.ecog)),  m)[["Pr(>|Chi|)"]][2],
  "ph.karno" = anova(update(m, . ~ . - ph.karno), m)[["Pr(>|Chi|)"]][2]
)

rownames(df) <- c("P_value")

kable(df)

```
Usuwamy ph.karno bo ma najwięszke p > 0.05


```{r krkr2coxkph}

m <- coxph(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) ,
                 data = dane)

df <- data.frame(
  "age" = anova(update(m, . ~ . - age), m)[["Pr(>|Chi|)"]][2],
  "sex" = anova(update(m, . ~ . - as.factor(sex)),      m)[["Pr(>|Chi|)"]][2],
  "ph.ecog" = anova(update(m, . ~ . - as.factor(ph.ecog)),  m)[["Pr(>|Chi|)"]][2]
)


rownames(df) <- c("P_value")

kable(df)

```

Usuwamy zmienną age bo ma największe p > 0.05

```{r krkr3cokxph}


m <- coxph(Surv(time, status)~as.factor(sex) + as.factor(ph.ecog) ,
                 data = dane)


df <- data.frame(
  "sex" = anova(update(m, . ~ . - as.factor(sex)),      m)[["Pr(>|Chi|)"]][2],
  "ph.ecog" = anova(update(m, . ~ . - as.factor(ph.ecog)),  m)[["Pr(>|Chi|)"]][2]
)


rownames(df) <- c("P_value")

kable(df)
```
Teraz wszystkie p < 0.05 więc mamy już gotowy model AIC.

W modelu końcowym zakłada się , że jedynymi znaczącymi zmiennymi są sex i ph.ecog

### b)

#### Treść

Korzystając z kryterium informacyjnego Akaike’a (AIC), dokonać wyboru najlepszego modelu
przyspieszonego czasu awarii, korzystając z funkcji step.

#### Rozwiązanie
```{r z_funkcją_step_cokxph}

m <- coxph(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane)

m_aic <- step(m, direction = "backward", trace = 1)


```
KROK 1
Z funkcji step widzimy, że wskażnik AIC
był najmniejszy dla zmiennej ph.karno, więc została ona usunięta.

KROK 2
Z funkcji step widzimy, że wskażnik AIC  
był najmniejszy dla zmiennej age, więc została ona usunięta.

KROK 3
Z funkcji step widzimy, że wskażnik AIC  
zwiększa sie w każdym możliwym kroku, więc nie ma sensu usuwać już żadnych zmiennych.

Nasz końcowy model zawiera zmienne sex oraz ph.ecoh ponieważ możemy uznać je za istotnie znaczące.



### c)

#### Treść

Korzystając z bayesowskiego kryterium informacyjnego (BIC), dokonać wyboru najlepszego
modelu przyspieszonego czasu awarii, korzystając z funkcji step.

#### Rozwiązanie



```{r BICstepks}


m <- coxph(Surv(time, status)~age + as.factor(sex) + as.factor(ph.ecog) + ph.karno,
                 data = dane)

n <- nrow(dane)
m_bic <- step(m, direction = "backward", k = log(n), trace = 1)



```

KROK 1
Z funkcji step widzimy, że wskażnik BIC
był najmniejszy dla zmiennej ph.karno, więc została ona usunięta.

KROK 2
Z funkcji step widzimy, że wskażnik BIC 
był najmniejszy dla zmiennej age, więc została ona usunięta.

KROK 3
Z funkcji step widzimy, że wskażnik BIC 
zwiększa sie w każdym możliwym kroku, więc nie ma sensu usuwać już żadnych zmiennych.

Nasz końcowy model zawiera zmienne sex oraz ph.ecoh ponieważ możemy uznać je za istotnie znaczące.
